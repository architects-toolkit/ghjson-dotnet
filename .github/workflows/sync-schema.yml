name: Sync Schema from ghjson-spec

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sync-schema:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Download remote schema
      run: |
        echo "Downloading schema from https://architects-toolkit.github.io/ghjson-spec/schema/v1.0/ghjson.schema.json"
        curl -s "https://architects-toolkit.github.io/ghjson-spec/schema/v1.0/ghjson.schema.json" -o remote-schema.json
        
    - name: Compare schemas
      id: compare
      run: |
        LOCAL_SCHEMA="src/GhJSON.Core/Validation/ghjson.schema.v1.0/ghjson.schema.json"
        REMOTE_SCHEMA="remote-schema.json"
        
        if [ ! -f "$LOCAL_SCHEMA" ]; then
          echo "Local schema file not found"
          exit 1
        fi
        
        # Compare files using checksum
        LOCAL_CHECKSUM=$(sha256sum "$LOCAL_SCHEMA" | cut -d' ' -f1)
        REMOTE_CHECKSUM=$(sha256sum "$REMOTE_SCHEMA" | cut -d' ' -f1)
        
        echo "Local checksum: $LOCAL_CHECKSUM"
        echo "Remote checksum: $REMOTE_CHECKSUM"
        
        if [ "$LOCAL_CHECKSUM" = "$REMOTE_CHECKSUM" ]; then
          echo "schemas_match=true" >> $GITHUB_OUTPUT
          echo "âœ… Schemas are identical"
        else
          echo "schemas_match=false" >> $GITHUB_OUTPUT
          echo "ðŸ”„ Schemas differ - update needed"
        fi
        
    - name: Update local schema
      if: steps.compare.outputs.schemas_match == 'false'
      run: |
        LOCAL_SCHEMA="src/GhJSON.Core/Validation/ghjson.schema.v1.0/ghjson.schema.json"
        REMOTE_SCHEMA="remote-schema.json"
        
        # Backup original file
        cp "$LOCAL_SCHEMA" "$LOCAL_SCHEMA.backup"
        
        # Replace with remote version
        cp "$REMOTE_SCHEMA" "$LOCAL_SCHEMA"
        
        echo "âœ… Updated local schema with remote version"
        echo "ðŸ“ Backup saved as: $LOCAL_SCHEMA.backup"
        
    - name: Show diff
      if: steps.compare.outputs.schemas_match == 'false'
      run: |
        LOCAL_SCHEMA="src/GhJSON.Core/Validation/ghjson.schema.v1.0/ghjson.schema.json"
        
        # Generate diff and save to file
        git diff --no-index "$LOCAL_SCHEMA.backup" "$LOCAL_SCHEMA" > diff.txt || true
        
        echo "## Schema Changes"
        echo "\`\`\`diff"
        cat diff.txt
        echo "\`\`\`"
        
    - name: Commit and push changes
      if: steps.compare.outputs.schemas_match == 'false'
      run: |
        LOCAL_SCHEMA="src/GhJSON.Core/Validation/ghjson.schema.v1.0/ghjson.schema.json"
        
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add and commit changes
        git add "$LOCAL_SCHEMA"
        git commit -m "ðŸ”„ Auto-sync schema from ghjson-spec
        
        - Updated ghjson.schema.json to match remote specification
        - Source: https://architects-toolkit.github.io/ghjson-spec/schema/v1.0/ghjson.schema.json
        
        This commit was automatically generated by GitHub Actions."
        
        # Push changes
        git push
        
    - name: Create comment on PR
      if: steps.compare.outputs.schemas_match == 'false'
      uses: actions/github-script@v7
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        script: |
          const fs = require('fs');
          
          // Read the diff and clean it up
          let diffOutput = '';
          try {
            diffOutput = fs.readFileSync('diff.txt', 'utf8');
            // Remove git diff exit code message if present
            diffOutput = diffOutput.replace(/^diff: .*\n/, '').trim();
            if (!diffOutput) {
              diffOutput = 'No visible changes (file content updated)';
            }
          } catch (error) {
            diffOutput = 'Unable to display diff';
          }
          
          // Escape backticks for markdown
          diffOutput = diffOutput.replace(/\`/g, '\\`');
          
          // Create comment
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ðŸ”„ Schema Auto-Synced
            
            The local schema file has been automatically updated to match the remote specification.
            
            **Source:** https://architects-toolkit.github.io/ghjson-spec/schema/v1.0/ghjson.schema.json
            
            **Changes:**
            \`\`\`diff
            ${diffOutput}
            \`\`\`
            
            **Files Updated:**
            - \`src/GhJSON.Core/Validation/ghjson.schema.v1.0/ghjson.schema.json\`
            
            This update was performed automatically by the [Sync Schema workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).
            `
          });
        
    - name: Success message
      if: steps.compare.outputs.schemas_match == 'true'
      run: |
        echo "âœ… Schema validation complete - no updates needed"
